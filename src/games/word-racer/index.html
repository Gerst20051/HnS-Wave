<!--
 ::::::::  :::::::::  ::::::::::     ::: ::::::::::: :::::::::: :::::::::       :::::::::  :::   :::
:+:    :+: :+:    :+: :+:          :+: :+:   :+:     :+:        :+:    :+:      :+:    :+: :+:   :+: :+:
+:+        +:+    +:+ +:+         +:+   +:+  +:+     +:+        +:+    +:+      +:+    +:+  +:+ +:+
+#+        +#++:++#:  +#++:++#   +#++:++#++: +#+     +#++:++#   +#+    +:+      +#++:++#+    +#++:
+#+        +#+    +#+ +#+        +#+     +#+ +#+     +#+        +#+    +#+      +#+    +#+    +#+
#+#    #+# #+#    #+# #+#        #+#     #+# #+#     #+#        #+#    #+#      #+#    #+#    #+#    #+#
 ########  ###    ### ########## ###     ### ###     ########## #########       #########     ###



    :::     ::::    ::: :::::::::  :::::::::  :::::::::: :::       :::       ::::::::  :::::::::: :::::::::   :::::::: :::::::::::
  :+: :+:   :+:+:   :+: :+:    :+: :+:    :+: :+:        :+:       :+:      :+:    :+: :+:        :+:    :+: :+:    :+:    :+:
 +:+   +:+  :+:+:+  +:+ +:+    +:+ +:+    +:+ +:+        +:+       +:+      +:+        +:+        +:+    +:+ +:+           +:+
+#++:++#++: +#+ +:+ +#+ +#+    +:+ +#++:++#:  +#++:++#   +#+  +:+  +#+      :#:        +#++:++#   +#++:++#:  +#++:++#++    +#+
+#+     +#+ +#+  +#+#+# +#+    +#+ +#+    +#+ +#+        +#+ +#+#+ +#+      +#+   +#+# +#+        +#+    +#+        +#+    +#+
#+#     #+# #+#   #+#+# #+#    #+# #+#    #+# #+#         #+#+# #+#+#       #+#    #+# #+#        #+#    #+# #+#    #+#    #+#
###     ### ###    #### #########  ###    ### ##########   ###   ###         ########  ########## ###    ###  ########     ###
-->
<!DOCTYPE html><html><head><meta charset="utf-8">
<title>Word Racer (via Canvas Engine)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.14.1/lodash.min.js"></script>
<script>__ = _.noConflict()</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="../canvasengine.js"></script>
<style>
body {
    background-color: rgb(130, 170, 230);
    margin: 0;
    padding: 0;
}

#canvaspane {
    cursor: default;
}
</style>
</head>
<body>
<div id="content">
<div id="canvaspane">
<canvas id="canvas1" height="100" width="100"></canvas>
</div>
</div>
<script>
var dictionary, frequencies, grids;
var trie = {};
var eow = '_';
var gridSolutions = [[], [], [], []];
var playGrids = {};
var pathTree = [{}, {}, {}, {}];

loadJSONFiles();

function loadJSONFiles() {
    var jsonPath = 'https://raw.githubusercontent.com/Gerst20051/HnS-Wave/wordracer/src/games/word-racer/';
    var getDictionaries = $.getJSON(jsonPath + 'dictionary.json');
    var getFrequencies = $.getJSON(jsonPath + 'frequencies.json');
    var getGrids = $.getJSON(jsonPath + 'round-grids.json');
    $.when(getDictionaries, getFrequencies, getGrids).done(function (dictionaryJSON, frequenciesJSON, gridJSON) {
        dictionary = dictionaryJSON[0];
        frequencies = frequenciesJSON[0];
        grids = gridJSON[0];
        init();
    });
}

function log(key, value) {
  console.log(key, JSON.stringify(value));
}

function init() {
  createTrie();
  generateGrid();
  generateGridSolutions();
}

function createTrie() {
  _.each(dictionary, word => {
    __.set(trie, `${word}${eow}`.split(''), true);
  });
}

function searchTrie(word) {
  return __.get(trie, `${word.toUpperCase()}${eow}`.split(''), false);
}

function existsInTrie(word) {
  return __.has(trie, word.toUpperCase().split('').join('.'));
}

function generateLetterDistribution() {
  const minFrequency = __.min(_.values(frequencies));
  const multiplier = __.round(102 / minFrequency);
  const letterCounts = __.mapValues(frequencies, (freq, letter) => { return __.round(freq * multiplier); });
  return _.reduce(letterCounts, (string, count, letter) => { return string += __.repeat(letter, count); }, '');
}

function generateGrid() {
  const letters = generateLetterDistribution();
  playGrids = _.map(grids, grid => {
    const count = _.reduce(_.flatten(grid), (carry, item) => { return item ? ++carry : carry; }, 0);
    const chars = _.map(_.times(count, () => _.sample(letters)), c => { return c === '0' ? 'Qu' : c });
    return _.map(grid, row => {
      return _.map(row, item => {
        return item ? chars.shift() : undefined;
      });
    });
  });
}

function generateGridSolutions() {
  _.each(playGrids, (grid, gridIndex) => {
    console.log(`Round ${gridIndex + 1}`);
    console.log(grid);
    _.each(grid, (row, rowIndex) => {
      _.each(row, (item, itemIndex) => {
        if (item) {
          const pathTreeKey = `${rowIndex},${itemIndex}`;
          pathTree[gridIndex][pathTreeKey] = {};
          spiderGridFromIndex(gridIndex, rowIndex, itemIndex, pathTreeKey, []);
        }
      });
    });
  });
}

function getNearGridOptions(grid, rowIndex, itemIndex) {
    const w = grid[rowIndex] && grid[rowIndex][itemIndex - 1] && [rowIndex, itemIndex - 1];
    const nw = grid[rowIndex - 1] && grid[rowIndex - 1][itemIndex - 1] && [rowIndex - 1 , itemIndex - 1];
    const n = grid[rowIndex - 1] && grid[rowIndex - 1][itemIndex] && [rowIndex - 1 , itemIndex];
    const ne = grid[rowIndex - 1] && grid[rowIndex - 1][itemIndex + 1] && [rowIndex - 1 , itemIndex + 1];
    const e = grid[rowIndex] && grid[rowIndex][itemIndex + 1] && [rowIndex , itemIndex + 1];
    const se = grid[rowIndex + 1] && grid[rowIndex + 1][itemIndex + 1] && [rowIndex + 1 , itemIndex + 1];
    const s = grid[rowIndex + 1] && grid[rowIndex + 1][itemIndex] && [rowIndex + 1 , itemIndex];
    const sw = grid[rowIndex + 1] && grid[rowIndex + 1][itemIndex - 1] && [rowIndex + 1 , itemIndex - 1];
    return [w, nw, n, ne, e, se, s, sw];
}

function setToValue(obj, value, path) {
  for (var i = 0; i < path.length - 1; i++) {
    obj = obj[path[i]];
  }
  obj[path[i]] = value;
}

function getWordFromPath(gridIndex, startingPathKey, path) {
  var word = '';
  for (var i = 0; i < path.length; i++) {
    const coords = path[i].split(',');
    word += playGrids[gridIndex][coords[0]][coords[1]];
  }
  return word;
}

function filterNearGridOptions(gridIndex, gridOptions, path) {
  return _.filter(gridOptions, gridOption => {
    return gridOption && !_.contains(path, `${gridOption[0]},${gridOption[1]}`);
  });
}

function spiderGridFromIndex(gridIndex, rowIndex, itemIndex, startingPathKey, fullPath) {
  const grid = playGrids[gridIndex];
  const nearGridOptionsFiltered = filterNearGridOptions(gridIndex, getNearGridOptions(grid, rowIndex, itemIndex), fullPath);
  _.each(nearGridOptionsFiltered, (gridOption, gridOptionIndex) => {
    const pathTreeKey = `${gridOption[0]},${gridOption[1]}`;
    const currentFullPath = fullPath.concat([ pathTreeKey ]);
    const currentWord = getWordFromPath(gridIndex, startingPathKey, currentFullPath);
    if (searchTrie(currentWord) && !_.contains(gridSolutions[gridIndex], currentWord)) {
      console.log(currentWord.toUpperCase());
      gridSolutions[gridIndex].push(currentWord);
    }
    if (existsInTrie(currentWord)) {
      spiderGridFromIndex(gridIndex, gridOption[0], gridOption[1], startingPathKey, currentFullPath);
    }
  });
}

var doFullScreen = false,
    centeredCanvas = true,
    canvasSize = {
        height: (doFullScreen) ? maxHeight : 800,
        width: (doFullScreen) ? maxWidth : 800
    };

var setup = function () {
    if (doFullScreen) {
        fullScreen();
    } else {
        size(canvasSize.width, canvasSize.height);
    }
    centerCanvas();
};

var draw = function () {
    background(color(130, 170, 230));
};

mouseClicked = function () {

};

windowResized = function () {
    centerCanvas();
};

function centerCanvas() {
    $canvas = $('#canvas1'), $window = $(window);
    $canvas.css('position', 'absolute');
    $canvas.css('top', (($window.height() - canvasSize.height) / 2) + 'px');
    $canvas.css('left', (($window.width() - canvasSize.width) / 2) + 'px');
}

window.onload = function () {
    window.canvas = new Canvas(document.getElementById('canvas1'));
    window.ctx = canvas.ctx;
    canvas.setup = window.setup;
    canvas.draw = window.draw;
    canvas.run();
};

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-42786295-1', 'hnswave.co');
ga('send', 'pageview');
</script>
</body>
</html>
